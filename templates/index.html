<!DOCTYPE html>
<html lang="en">
<head>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r134/three.min.js"></script>
    <script src="https://www.vantajs.com/dist/vanta.cells.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/typeit@7.0.4/dist/typeit.min.js"></script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dinner Party Personality Test</title>
    <link href="https://fonts.googleapis.com/css2?family=Red+Hat+Display:wght@400;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inconsolata:wght@400;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Libre+Baskerville&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Gloria+Hallelujah&display=swap" rel="stylesheet">    
   <style>
        /* Add styles for the typewriter animation */
        /* .typewriter {
        overflow: hidden;
        border-right: .15em solid transparent;
        white-space: nowrap;
        animation: typing 3.5s steps(40, end), blink-caret .5s step-end infinite;
    } */

    @keyframes typing {
        from { width: 0 }
        to { width: 100% }
    }

    @keyframes blink-caret {
        50% { border-color: transparent; }
    }

    /* Add styles for the glow effect */
    .glow {
        text-shadow: 0 0 10px transparent, 0 0 20px transparent, 0 0 30px transparent, 0 0 40px transparent, 0 0 50px #ffffff, 0 0 60px #ffffff;
    }
        body {
            font-family: 'Red Hat Display', sans-serif;
            /* background-color: #f0f0f0; */
        }
        h1 {
            /* font-family: 'Inconsolata', sans-serif; */
            color: white;
            text-align: center;
            /* text-shadow: 2px 2px 4px #374d27; */
        }

        p {
            color: white;
            text-align: center;
            /* font-family: 'Inconsolata', sans-serif; */
        }

        #analysis-panel, #chat-container {
            max-width: 800px;
            margin: auto;
            padding: 20px;
            background-color: rgba(0, 0, 0, 0.3); /* Adjust the last value (0.3) to control the translucency */
            border: none;
            border-radius: 50px;
    }

        .message {
            padding: 10px;
            /* font-family: 'Libre Baskerville', serif;  */
            margin-bottom: 15px; 
            background-color: transparent; 
        }

        .question {
            background-color: transparent;
            margin-bottom: 15px; 
            padding: 10px;
            font-family: 'Libre Baskerville', serif;
        }

        .response-input {
            font-family: 'Red Hat Display', sans-serif;
            height: 100px;
            resize: vertical;
            padding: 12px 20px;
            font-size: 15px;
            border-radius: 4px;
            background-color: #faefff;
            width: calc(100% - 40px);
            margin-left: auto;
            margin-right: auto;
            display: block;
        }

        .sick-button {
            font-family: 'Red Hat Display', sans-serif;
            font-size: 15px;
            font-weight: bold;
            letter-spacing: 2px;
            color: #ffffff;
            padding: 12px 20px;
            border: none;
            outline: none;
            border-radius: 50px;
            cursor: pointer;
            display: block;
            margin: 0 auto;
            position: relative;
            margin-top: 20px;
            background: linear-gradient(90deg, #111, #d2a9e8, #374d27, #111);
            background-size: 400%;
            z-index: 1;
            }
        .sick-button:hover {
                animation: animate 8s linear infinite;
        }
        @keyframes animate {
            0% {
                background-position: 0%;
            }
            100% {
                background-position: 400%;
            }
        }
            
        .sick-button:before {
            content: "";
            position: absolute;
            top: -5px;
            right: -5px;
            bottom: -5px;
            left: -5px;
            z-index: -1;
            background: linear-gradient(90deg, #111, #d2a9e8, #374d27, #111);
            background-size: 400%;
            border-radius: 40px;
            opacity: 0;
            transition: .5s;
            }
            
        .sick-button:hover:before {
            filter: blur(20px);
            opacity: 1;
            animation: animate 8s linear infinite;
            }

    </style>
</head>
<body>
    <div id="vanta-bg" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: -1;"></div>
    <p id="welcome-message" >This is a personality test. Please respond as elaborately as possible (the more words, the better). After 15 questions, you will have the option to view the results.</p>
        <!-- Question and response elements will be inserted here using JavaScript -->
    </div>
    <div id="analysis-panel" style="display: none;">
        <!-- Analysis elements will be inserted here using JavaScript -->
    </div>
    <div id="chat-container">
        <!-- Analysis elements will be inserted here using JavaScript -->
    </div>
    <button id="analysis" class="sick-button">VIEW ANALYSIS</button>
    <button id="next" class="sick-button">START</button>
    <h1 id="loadingMessage" style="display:none;">Analysis Loading...</h1>
    <script>
function appendQuestion(question) {
    const questionElement = $('<div class="question glow"></div>');
    questionElement.appendTo("#chat-container");
    new TypeIt(questionElement[0], {
        strings: question,
        speed: 80,
        waitUntilVisible: true
    }).go();
}
    // setTimeout(function() {
    //     questionElement.removeClass('typewriter');
    // }, 3500);


function typeQuestion(question) {
    return new Promise(function(resolve) {
        appendQuestion(question);
        setTimeout(resolve, 3500);
    });
}


        function appendResponse(response) {
            $("#chat-container").append('<div class="message response">' + response + '</div>');
        }

        function getUserInput() {
            return new Promise(function(resolve, reject) {
                let responseInput = $('<textarea class="response-input"></textarea>');
                let sendButton = $('<button class="sick-button">SEND</button>');
                $("#chat-container").append(responseInput);
                $("#chat-container").append(sendButton);
                responseInput.focus();
                sendButton.click(function() {
                    resolve(responseInput.val());
                    responseInput.remove();
                    sendButton.remove();
                });
                responseInput.on('keypress', function(e) {
                    if (e.which == 13) {
                        resolve(responseInput.val());
                        responseInput.remove();
                        sendButton.remove();
                    }
                });
            });
        }


        async function startGame() {
            
            const questions = await $.getJSON('/game/start');
            let all_responses = [];
            let questionCounter = 0;
            $("#analysis").hide();
            $("#chat-container").hide();
            $("#analysis-panel").hide();
            

            function handleNextButtonClick() {
                $("#chat-container").empty();
                $("#chat-container").show();
                $("#welcome-message").hide();
                if (questionCounter < questions.length) {
                    askQuestion(questions[questionCounter]);
                    questionCounter++;
                    if (questionCounter >= questions.length) {
                        $("#next").hide();
                    }
                }
                $("#next").text("NEXT QUESTION");
            
            }
            $("#next").on("click", handleNextButtonClick);


            async function askQuestion(question) {
                $("#next").hide();
                appendQuestion(question);
                let answer = await getUserInput();
                appendResponse(answer);
                all_responses.push({"role": "assistant", "content": question});
                all_responses.push({"role": "user", "content": answer});
                let context = "You just asked this person" + question +"Ask a single follow-up question, continuing the hypothetical conversation, and subtly encouraging them to elaborate on their answer and reveal more about why they answered the given question the way they did. Perhaps play devil's advocate if it will encourage them to explore other aspects of the original question. They answered" + answer + ". Attempt primarily to get to the heart of WHY they gave that answer.";

                for (let j = 0; j < 2; j++) {
                    const follow_up_data = {"answer": answer, "context": context};
                    const follow_up_question = await $.ajax({
                        url: "/game/follow_up",
                        type: "POST",
                        contentType: "application/json",
                        data: JSON.stringify(follow_up_data)
                    });
                    appendQuestion(follow_up_question);
                    answer = await getUserInput();
                    appendResponse(answer);
                    all_responses.push({"role": "assistant", "content": follow_up_question});
                    all_responses.push({"role": "user", "content": answer});
                    context += " Note that when asked " + follow_up_question + " they responded " + answer+ ".";
                }
                $("#next").show();
                if (questionCounter >= 5) {
                    $("#next").hide();
                    $("#analysis").show();
                }
            }


            // for (let question of questions) {
            //     await askQuestion(question);
            //     questionCounter++;
            // }

            // Store all_responses for analysis
            $("#analysis").data("responses", all_responses);
        }



        $("#analysis").click(async function() {
            $("#next").hide();
            $("#welcome-message").hide();
            $("#chat-container").hide();
            $("#loadingMessage").show();
            
            $(this).hide();
            const responses = $("#analysis").data("responses");
            console.log("Submitting responses:", responses);
            const analysis = await $.ajax({
                url: "/game/analyze",
                type: "POST",
                contentType: "application/json",
                data: JSON.stringify(responses)
            });
            $("#loadingMessage").hide();
            $("#analysis-panel").show();

            // // $("#chat-container").hide();
            // $("#analysis-panel").show();

            // Display the analysis response in your chat container or any other suitable location
            $("#analysis-panel").append('<div class="message question">Analysis:</div>');
            $("#analysis-panel").append('<div class="message response">' + analysis + '</div>');
        });

        $(document).ready(function() {
            VANTA.CELLS({
                el: "#vanta-bg",
                mouseControls: true,
                touchControls: true,
                gyroControls: false,
                minHeight: 200.00,
                minWidth: 200.00,
                scale: 1.00,
                color1: 0x749b5a,
                color2: 0xd2a9e8
                })
            });


        // Start the game when the page loads
        $(document).ready(startGame);
    </script>
</body>
</html>
